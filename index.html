<!DOCTYPE html>
<html>
<head>
  <title>Hindustani Raags</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f3f3f3; }
    input { padding: 8px; width: 300px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    tr.details { display: none; background: #eaeaea; }
    span.highlight { background-color: yellow; }
  </style>
</head>
<body>
	<h2>Raags</h2>
	<input type="text" id="raagSearch" placeholder="Search Raags">
	<table id="raagsTable" border="1">
	  <thead>
		<tr>
		  <th>ID</th>
		  <th>Name</th>
		  <th>Thaat</th>
		  <th>Aaroh</th>
		  <th>Avaroh</th>
		</tr>
	  </thead>
	  <tbody></tbody>
	</table>

	<h2>Thaats</h2>
	<input type="text" id="thaatSearch" placeholder="Search Thaats">
	<table id="thaatTable" border="1">
	  <thead>
		<tr>
		  <th>ID</th>
		  <th>Name</th>
		  <th>Scale</th>
		</tr>
	  </thead>
	  <tbody></tbody>
	</table>

<!-- Supabase JS library -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = "https://cxjfqwnmabyabhjhadjy.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4amZxd25tYWJ5YWJoamhhZGp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5Njc2NDUsImV4cCI6MjA3MTU0MzY0NX0.qbI-CU_wgAioBihGx54RXpr4cBryhzIjc4C8iT5YAX0";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helper: turn "0 5 7" into [0,5,7], ignoring non-numbers
  function parseInts(raw) {
    return raw.trim()
      .split(/[\s,]+/)
      .map(x => parseInt(x, 10))
      .filter(Number.isFinite);
  }

  // -------------------------
  // Load Raags (id, name, thaat, aaroh, avaroh)
  // Exact integer set match: any order, must contain all numbers
  // -------------------------
  async function loadRaags(search = "") {
    try {
      let query = supabaseClient
        .from("raags")
        .select("id, name, thaat, aaroh, avaroh");

      const nums = parseInts(search);
      if (nums.length > 0) {
        // Use PostgREST 'cs' (contains) operator via .or()
        // Checks: aaroh @> {..} OR avaroh @> {..}
        const arrLiteral = `{${nums.join(",")}}`;
        query = query.or(`aaroh.cs.${arrLiteral},avaroh.cs.${arrLiteral}`);
      }

      const { data, error } = await query;
      if (error) throw error;

      const tbody = document.querySelector("#raagsTable tbody");
      tbody.innerHTML = "";
      if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>No raags found</td></tr>";
        return;
      }

      data.forEach(r => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${r.id}</td>
          <td>${r.name ?? ""}</td>
          <td>${r.thaat ?? ""}</td>
          <td>${Array.isArray(r.aaroh) ? r.aaroh.join(",") : (r.aaroh ?? "")}</td>
          <td>${Array.isArray(r.avaroh) ? r.avaroh.join(",") : (r.avaroh ?? "")}</td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Raags load error:", err);
      const tbody = document.querySelector("#raagsTable tbody");
      if (tbody) tbody.innerHTML = "<tr><td colspan='5'>Error loading raags</td></tr>";
    }
  }

  document.getElementById("raagSearch").addEventListener("input", (e) => {
    loadRaags(e.target.value);
  });
  loadRaags();

  // -------------------------
  // Load Thaats (id, name, scale)
  // Exact integer set match on 'scale' ONLY
  // -------------------------
  async function loadThaats(search = "") {
    try {
      let query = supabaseClient
        .from("thaat")
        .select("id, name, scale");

      const nums = parseInts(search);
      if (nums.length > 0) {
        // Use QueryBuilder .contains for array @>
        query = query.contains("scale", nums);
      }

      const { data, error } = await query;
      if (error) throw error;

      const tbody = document.querySelector("#thaatTable tbody");
      tbody.innerHTML = "";
      if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='3'>No thaats found</td></tr>";
        return;
      }

      data.forEach(t => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${t.id}</td>
          <td>${t.name ?? ""}</td>
          <td>${Array.isArray(t.scale) ? t.scale.join(",") : (t.scale ?? "")}</td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error("Thaats load error:", err);
      const tbody = document.querySelector("#thaatTable tbody");
      if (tbody) tbody.innerHTML = "<tr><td colspan='3'>Error loading thaats</td></tr>";
    }
  }

  document.getElementById("thaatSearch").addEventListener("input", (e) => {
    loadThaats(e.target.value);
  });
  loadThaats();
</script>
</body>
</html>
